name: CI/CD for PocketForge

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # --- Backend CI/CD ---
  backend-build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          target: x86_64-unknown-linux-musl
          override: true

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            PocketForge/backend/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('PocketForge/backend/Cargo.lock') }}

      - name: Build Backend
        run: cargo build --release --target x86_64-unknown-linux-musl
        working-directory: ./PocketForge/backend

      - name: Deploy to Fly.io
        uses: superfly/flyctl-actions/deploy@latest
        with:
          path: ./PocketForge/backend
          args: "--remote-only"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          # Set secrets for the application environment
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GITHUB_CLIENT_ID: ${{ secrets.GITHUB_CLIENT_ID }}
          GITHUB_CLIENT_SECRET: ${{ secrets.GITHUB_CLIENT_SECRET }}

  # --- Frontend CI/CD (Android/Desktop/Web) ---
  frontend-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Kotlin/Compose
        uses: actions/setup-gradle@v4
        
      - name: Build Android Release
        run: ./gradlew :frontend:android:assembleRelease
        working-directory: ./PocketForge
        
      - name: Build Desktop Release
        run: ./gradlew :frontend:desktop:packageDistributionForCurrentOS
        working-directory: ./PocketForge

      - name: Build Web (WASM)
        run: ./gradlew :frontend:wasmJs:browserProductionWebpack
        working-directory: ./PocketForge
        
      - name: Upload Android Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pocketforge-android-apk
          path: PocketForge/frontend/android/build/outputs/apk/release/
          
      - name: Upload Desktop Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pocketforge-desktop-app
          path: PocketForge/frontend/desktop/build/compose/binaries/main/
